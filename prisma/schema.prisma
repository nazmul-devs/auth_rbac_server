generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Models
model User {
    id                   String         @id @default(uuid())
    name                 String?
    mobile               String?
    email                String         @unique
    username             String         @unique
    password_hash        String
    verification_token   String?
    verification_expires DateTime?
    two_fa_enabled       Boolean        @default(false)
    status               UserStatus     @default(PENDING_VERIFICATION)
    created_at           DateTime       @default(now())
    updated_at           DateTime       @updatedAt
    roles                UserRole[]
    refresh_tokens       RefreshToken[]
}

enum UserStatus {
    UNVERIFIED
    PENDING_VERIFICATION
    ACTIVE
    ONLINE
    OFFLINE
    AWAY
    SUSPENDED
    BANNED
    RESTRICTED
    INACTIVE
    DELETED
    ARCHIVED
}

// Role Models
model Role {
    id          String           @id @default(uuid())
    name        String           @unique
    description String?
    permissions RolePermission[]
    users       UserRole[]
    service_roles ServiceRole[]
}

model Permission {
    id    String           @id @default(uuid())
    name  String           @unique
    desc  String?
    roles RolePermission[]
}

model UserRole {
    id      String @id @default(uuid())
    user    User   @relation(fields: [user_id], references: [id])
    user_id String
    role    Role   @relation(fields: [role_id], references: [id])
    role_id String

    @@unique([user_id, role_id])
}

model RolePermission {
    id            String     @id @default(uuid())
    role          Role       @relation(fields: [role_id], references: [id])
    role_id       String
    permission    Permission @relation(fields: [permission_id], references: [id])
    permission_id String

    @@unique([role_id, permission_id])
}

model RefreshToken {
    id             String   @id @default(uuid())
    token_hash     String   @unique
    user_id        String
    revoked        Boolean  @default(false)
    created_at     DateTime @default(now())
    device_id      String? 
    device_name    String? 
    replaced_by_id String?
    expires_at     DateTime
    user           User     @relation(fields: [user_id], references: [id])
}

// Service Models
model ServiceClient {
    id                 String        @id @default(uuid())
    client_id          String        @unique
    client_secret_hash String
    name               String
    description        String?
    is_active          Boolean       @default(true)
    created_at         DateTime      @default(now())
    updated_at         DateTime      @updatedAt
    roles              ServiceRole[]
}

model ServiceRole {
    id               String        @id @default(uuid())
    service_client   ServiceClient @relation(fields: [service_client_id], references: [id])
    service_client_id String
    role             Role          @relation(fields: [role_id], references: [id])
    role_id          String

    @@unique([service_client_id, role_id])
}
